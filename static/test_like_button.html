<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Like Button Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .like-button {
            cursor: pointer !important;
            transition: all 0.2s ease;
            border-radius: 4px;
            padding: 2px 4px;
        }
        .like-button:hover {
            background-color: rgba(220, 53, 69, 0.1);
            color: #dc3545 !important;
        }
        .like-button.liked {
            color: #dc3545 !important;
        }
        .like-button.liked i {
            color: #dc3545 !important;
        }
        .like-button.loading {
            opacity: 0.6;
            cursor: not-allowed !important;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1>ðŸ§ª Like Button Test</h1>
        <p>This page tests the like button functionality for your Bluesky app.</p>
        
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">Test Post</h6>
                <small class="text-muted">@test.user</small>
            </div>
            <div class="card-body">
                <p>This is a test post to verify the like button functionality.</p>
                <div class="engagement-metrics">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="engagement-stats">
                            <span class="like-button" 
                                  title="Likes" 
                                  data-post-uri="at://did:plc:yv3oh5q77h4hl5j7hp4hj6vy/app.bsky.feed.post/3lyyfwui22s2s" 
                                  data-post-index="0">
                                <i class="fas fa-heart"></i> <span class="like-count">1</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="alert alert-info">
            <h5>Test Instructions:</h5>
            <ol>
                <li>Click the heart button above</li>
                <li>Watch for visual feedback (color change, loading state)</li>
                <li>Check the like count updates</li>
                <li>Click again to unlike</li>
            </ol>
        </div>
        
        <div id="test-results" class="mt-4"></div>
    </div>

    <script>
        // Simplified version of the like button functionality for testing
        const ApiService = {
            baseUrl: '',
            
            async request(endpoint, options = {}) {
                const url = `${this.baseUrl}${endpoint}`;
                const config = {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                };

                try {
                    const response = await fetch(url, config);
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || `HTTP ${response.status}`);
                    }
                    
                    return data;
                } catch (error) {
                    console.error(`API request failed: ${endpoint}`, error);
                    throw error;
                }
            },

            async likePost(postUri) {
                return this.request('/api/like', {
                    method: 'POST',
                    body: JSON.stringify({
                        post_uri: postUri
                    })
                });
            },

            async unlikePost(postUri) {
                return this.request('/api/unlike', {
                    method: 'POST',
                    body: JSON.stringify({
                        post_uri: postUri
                    })
                });
            }
        };

        // Handle like button click
        function handleLikeClick(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const likeButton = event.currentTarget;
            const postUri = likeButton.getAttribute('data-post-uri');
            const postIndex = parseInt(likeButton.getAttribute('data-post-index'));
            
            if (!postUri || isNaN(postIndex)) {
                console.error('Invalid like button data:', { postUri, postIndex });
                return;
            }

            // Check if already liked
            const isLiked = likeButton.classList.contains('liked');
            
            // Set loading state
            likeButton.classList.add('loading');
            likeButton.style.pointerEvents = 'none';

            // Call appropriate API method
            const apiCall = isLiked ? ApiService.unlikePost(postUri) : ApiService.likePost(postUri);
            
            apiCall.then(response => {
                if (response.success) {
                    // Update UI state
                    const likeCountSpan = likeButton.querySelector('.like-count');
                    const currentCount = parseInt(likeCountSpan.textContent) || 0;
                    const newCount = isLiked ? Math.max(0, currentCount - 1) : currentCount + 1;
                    
                    likeCountSpan.textContent = newCount;
                    
                    // Update like state
                    if (isLiked) {
                        likeButton.classList.remove('liked');
                    } else {
                        likeButton.classList.add('liked');
                    }
                    
                    // Show success feedback
                    showTestResult(`âœ… ${isLiked ? 'Unliked' : 'Liked'} successfully! New count: ${newCount}`, 'success');
                } else {
                    console.error('Like action failed:', response.error);
                    showTestResult(`âŒ Failed to ${isLiked ? 'unlike' : 'like'}: ${response.error}`, 'danger');
                }
            }).catch(error => {
                console.error('Error with like action:', error);
                showTestResult(`âŒ Error ${isLiked ? 'unliking' : 'liking'}: ${error.message}`, 'danger');
            }).finally(() => {
                // Remove loading state
                likeButton.classList.remove('loading');
                likeButton.style.pointerEvents = 'auto';
            });
        }

        function showTestResult(message, type) {
            const resultsDiv = document.getElementById('test-results');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            resultsDiv.appendChild(alertDiv);
        }

        // Add event listener to like button
        document.addEventListener('DOMContentLoaded', function() {
            const likeButton = document.querySelector('.like-button');
            if (likeButton) {
                likeButton.addEventListener('click', handleLikeClick);
                showTestResult('ðŸ§ª Test page loaded. Click the heart button to test like functionality.', 'info');
            }
        });
    </script>
</body>
</html>
