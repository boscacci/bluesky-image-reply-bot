{% extends "base.html" %}

{% block title %}Bluesky Custom Feed - Posts with Images from Followed Users{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h2">
                    <i class="fas fa-images text-primary"></i> 
                    Posts with Images from Users You Follow
                </h1>
                <div class="d-flex align-items-center mt-2">
                    <span id="status-indicator" class="badge bg-secondary me-2 d-flex align-items-center">
                        <i class="fas fa-circle me-1"></i> Checking connection...
                    </span>
                    <small class="text-muted">Custom Feed ‚Ä¢ Followed Users Only ‚Ä¢ Includes Reposts from Followed Users</small>
                </div>
            </div>
            <div>
                <button class="btn btn-primary" id="refresh-btn" onclick="loadPosts()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="btn btn-outline-secondary ms-2" id="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode (Ctrl+D)">
                    <i class="fas fa-moon" id="theme-icon"></i>
                </button>
                <button class="btn btn-outline-info ms-2" onclick="showKeyboardShortcuts()" title="Keyboard shortcuts (Ctrl+?)">
                    <i class="fas fa-keyboard"></i>
                </button>
                <div class="btn-group ms-2" role="group">
                    <input type="radio" class="btn-check" name="postCount" id="count6" value="6" checked>
                    <label class="btn btn-outline-secondary" for="count6">6</label>
                    
                    <input type="radio" class="btn-check" name="postCount" id="count18" value="18">
                    <label class="btn btn-outline-secondary" for="count18">18</label>
                </div>
                <div class="btn-group ms-2" role="group">
                    <input type="radio" class="btn-check" name="maxPerUser" id="max1" value="1" checked>
                    <label class="btn btn-outline-info" for="max1">1/user</label>
                </div>
                <button class="btn btn-outline-warning ms-2" onclick="showThemeConfig()" title="Configure AI reply themes">
                    <i class="fas fa-palette"></i> AI Themes
                </button>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loading" class="text-center py-5" style="display: none;">
            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="progress-text">
                <h4 class="text-primary mb-2">Fetching Posts from Your Custom Feed</h4>
                <p class="text-muted">Searching through posts from users you follow for images (includes reposts from followed users)...</p>
                <div class="progress mt-3" style="height: 8px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                         role="progressbar" 
                         style="width: 0%" 
                         aria-valuenow="0" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                    </div>
                </div>
            </div>
        </div>

        <!-- Success Alert -->
        <div id="success-alert" class="alert alert-success" style="display: none;" role="alert">
            <i class="fas fa-check-circle"></i>
            <span id="success-message"></span>
        </div>

        <!-- Error Alert -->
        <div id="error-alert" class="alert alert-danger" style="display: none;" role="alert">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="error-message"></span>
        </div>

        <!-- Posts Container -->
        <div id="posts-container">
            <!-- Posts will be loaded here -->
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="text-center py-5" style="display: none;">
            <i class="fas fa-images fa-3x text-muted mb-3"></i>
            <h3 class="text-muted">No posts with images found</h3>
            <p class="text-muted">The app searches through posts from users you follow for images (includes reposts from followed users). Try refreshing or check your Bluesky connection.</p>
        </div>
    </div>
</div>

<!-- Theme Configuration Modal -->
<div class="modal fade" id="themeConfigModal" tabindex="-1" aria-labelledby="themeConfigModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="themeConfigModalLabel">
                    <i class="fas fa-palette me-2"></i>AI Reply Theme Configuration
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="mb-3">Theme</h6>
                        <div class="mb-3">
                            <select class="form-select" id="themeSelect">
                                <option value="cycling">üö≤ Cycling & Accessibility</option>
                                <option value="environment">üå± Environment & Sustainability</option>
                                <option value="technology">üíª Technology & Innovation</option>
                                <option value="community">ü§ù Community & Engagement</option>
                            </select>
                            <div class="form-text">Choose the main theme for AI replies</div>
                        </div>
                        
                        <h6 class="mb-3">Tone</h6>
                        <div class="mb-3">
                            <select class="form-select" id="toneSelect">
                                <option value="enthusiastic">üòä Enthusiastic & Energetic</option>
                                <option value="professional">üíº Professional & Informative</option>
                                <option value="casual">üòé Casual & Friendly</option>
                                <option value="humorous">üòÑ Light-hearted & Witty</option>
                            </select>
                            <div class="form-text">Choose the tone of voice for AI replies</div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h6 class="mb-3">Style</h6>
                        <div class="mb-3">
                            <select class="form-select" id="styleSelect">
                                <option value="conversational">üí¨ Conversational & Natural</option>
                                <option value="formal">üìù Formal & Polished</option>
                                <option value="brief">‚ö° Brief & Concise</option>
                            </select>
                            <div class="form-text">Choose the writing style for AI replies</div>
                        </div>
                        
                        <h6 class="mb-3">Preview</h6>
                        <div class="p-3 bg-light rounded" id="themePreview">
                            <small class="text-muted">Select options above to see a preview of the AI reply style</small>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h6 class="mb-3">Current Configuration</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h6 class="card-title">Theme</h6>
                                    <span class="badge bg-primary" id="currentTheme">Cycling</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h6 class="card-title">Tone</h6>
                                    <span class="badge bg-success" id="currentTone">Enthusiastic</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h6 class="card-title">Style</h6>
                                    <span class="badge bg-info" id="currentStyle">Conversational</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveThemeConfig()">Save Configuration</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize theme and keyboard shortcuts
document.addEventListener('DOMContentLoaded', function() {
    // Initialize theme
    const savedTheme = localStorage.getItem('theme') || 'light';
    setTheme(savedTheme);
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + D: Toggle dark mode
        if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
            e.preventDefault();
            toggleTheme();
        }
        // Escape: Close any open modals
        if (e.key === 'Escape') {
            const modals = document.querySelectorAll('.modal.show');
            modals.forEach(modal => {
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) bsModal.hide();
            });
        }
        // Ctrl/Cmd + ?: Show keyboard shortcuts
        if ((e.ctrlKey || e.metaKey) && e.key === '?') {
            e.preventDefault();
            showKeyboardShortcuts();
        }
    });
});

// Theme management
function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-bs-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    setTheme(newTheme);
    localStorage.setItem('theme', newTheme);
}

function setTheme(theme) {
    document.documentElement.setAttribute('data-bs-theme', theme);
    const themeIcon = document.getElementById('theme-icon');
    if (theme === 'dark') {
        themeIcon.className = 'fas fa-sun';
    } else {
        themeIcon.className = 'fas fa-moon';
    }
}

// Show keyboard shortcuts modal
function showKeyboardShortcuts() {
    // Create modal if it doesn't exist
    let modal = document.getElementById('shortcutsModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'shortcutsModal';
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-keyboard me-2"></i>Keyboard Shortcuts
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-6">
                                <h6>Navigation</h6>
                                <ul class="list-unstyled">
                                    <li><kbd>Ctrl</kbd> + <kbd>R</kbd> - Refresh posts</li>
                                    <li><kbd>Ctrl</kbd> + <kbd>D</kbd> - Toggle dark mode</li>
                                    <li><kbd>Ctrl</kbd> + <kbd>?</kbd> - Show this help</li>
                                    <li><kbd>Esc</kbd> - Close modals</li>
                                </ul>
                            </div>
                            <div class="col-6">
                                <h6>Tips</h6>
                                <ul class="list-unstyled">
                                    <li>Click images to view full size</li>
                                    <li>Use the controls above to adjust settings</li>
                                    <li>Posts are from users you follow only (includes reposts from followed users)</li>
                                    <li>Settings are saved automatically</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

// Theme configuration functions
function showThemeConfig() {
    // Load current theme configuration
    loadCurrentThemeConfig();
    
    // Add event listeners for live preview
    document.getElementById('themeSelect').addEventListener('change', updateThemePreview);
    document.getElementById('toneSelect').addEventListener('change', updateThemePreview);
    document.getElementById('styleSelect').addEventListener('change', updateThemePreview);
    
    const modal = new bootstrap.Modal(document.getElementById('themeConfigModal'));
    modal.show();
}

function loadCurrentThemeConfig() {
    // Load from localStorage or use defaults
    const currentConfig = JSON.parse(localStorage.getItem('aiThemeConfig') || '{"theme": "cycling", "tone": "enthusiastic", "style": "conversational"}');
    
    document.getElementById('themeSelect').value = currentConfig.theme;
    document.getElementById('toneSelect').value = currentConfig.tone;
    document.getElementById('styleSelect').value = currentConfig.style;
    
    updateCurrentConfigDisplay(currentConfig);
    updateThemePreview();
}

function updateCurrentConfigDisplay(config) {
    const themeLabels = {
        'cycling': 'Cycling',
        'environment': 'Environment',
        'technology': 'Technology',
        'community': 'Community'
    };
    
    const toneLabels = {
        'enthusiastic': 'Enthusiastic',
        'professional': 'Professional',
        'casual': 'Casual',
        'humorous': 'Humorous'
    };
    
    const styleLabels = {
        'conversational': 'Conversational',
        'formal': 'Formal',
        'brief': 'Brief'
    };
    
    document.getElementById('currentTheme').textContent = themeLabels[config.theme] || 'Cycling';
    document.getElementById('currentTone').textContent = toneLabels[config.tone] || 'Enthusiastic';
    document.getElementById('currentStyle').textContent = styleLabels[config.style] || 'Conversational';
}

function updateThemePreview() {
    const theme = document.getElementById('themeSelect').value;
    const tone = document.getElementById('toneSelect').value;
    const style = document.getElementById('styleSelect').value;
    
    const previews = {
        'cycling': {
            'enthusiastic': 'This is exactly the kind of cycling infrastructure we need! Safe, accessible design benefits everyone in our community üö≤‚ôø',
            'professional': 'This cycling infrastructure demonstrates excellent urban planning principles that prioritize safety and accessibility for all users.',
            'casual': 'Nice bike infrastructure! This is how we make cities more livable for everyone üö¥‚Äç‚ôÄÔ∏è',
            'humorous': 'Finally, bike lanes that don\'t disappear into thin air! This is infrastructure that actually works üö≤‚ú®'
        },
        'environment': {
            'enthusiastic': 'This is exactly the kind of environmental progress we need! Every step toward sustainability makes a difference üå±',
            'professional': 'This initiative demonstrates effective environmental stewardship and sustainable practices that benefit our ecosystem.',
            'casual': 'Love seeing environmental action in practice! This is how we protect our planet üåç',
            'humorous': 'Mother Nature is definitely giving this a thumbs up! Great environmental initiative üåøüëç'
        },
        'technology': {
            'enthusiastic': 'This is exactly the kind of innovation we need! Technology that makes life better for everyone üíª',
            'professional': 'This technological solution demonstrates effective implementation of digital tools that enhance user experience.',
            'casual': 'Cool tech! This is how innovation should work - making things better for people ü§ñ',
            'humorous': 'Finally, technology that doesn\'t make you want to throw your computer out the window! üñ•Ô∏è‚ú®'
        },
        'community': {
            'enthusiastic': 'This is exactly the kind of community spirit we need! Connection and support make neighborhoods stronger ü§ù',
            'professional': 'This community initiative demonstrates effective social engagement and neighborhood development strategies.',
            'casual': 'Love seeing community building in action! This is how neighborhoods thrive üèòÔ∏è',
            'humorous': 'This is what happens when neighbors actually talk to each other - magic! üè†‚ú®'
        }
    };
    
    const preview = previews[theme]?.[tone] || 'This is a great example of positive community action!';
    document.getElementById('themePreview').innerHTML = `<em>"${preview}"</em>`;
}

function saveThemeConfig() {
    const config = {
        theme: document.getElementById('themeSelect').value,
        tone: document.getElementById('toneSelect').value,
        style: document.getElementById('styleSelect').value
    };
    
    // Save to localStorage
    localStorage.setItem('aiThemeConfig', JSON.stringify(config));
    
    // Update current config display
    updateCurrentConfigDisplay(config);
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('themeConfigModal'));
    modal.hide();
    
    // Show success message
    showSuccessMessage('AI theme configuration saved successfully!');
}

function showSuccessMessage(message) {
    const successAlert = document.getElementById('success-alert');
    const successMessage = document.getElementById('success-message');
    successMessage.textContent = message;
    successAlert.style.display = 'block';
    
    setTimeout(() => {
        successAlert.style.display = 'none';
    }, 3000);
}

// Make functions globally available
window.showThemeConfig = showThemeConfig;
window.saveThemeConfig = saveThemeConfig;
</script>
{% endblock %}
